<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - GruzDelivery</title>
    <link rel="stylesheet" href="/static/css/style.css?v=14">
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">üöö</div>
            GruzDelivery
        </a>
    </header>

    <div class="container">
        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
        <div class="calculator-shortcut">
            <a class="calculator-btn is-disabled" id="calculatorBtn">
                üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
                <span class="cart-count" id="cartCount">0</span>
            </a>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="search-section">
            <form class="search-form" method="POST" action="/api/transport-services/search">
                <input 
                    type="text" 
                    name="search_query" 
                    class="search-input" 
                    placeholder="–ü–æ–∏—Å–∫ —Ç–∏–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (—Ñ—É—Ä–∞, –∞–≤–∏–∞, –ø–æ–µ–∑–¥...)" 
                    value="{{ .search }}"
                >
                <input type="hidden" name="transport_type" value="">
                <button type="submit" class="search-btn">üîç</button>
            </form>
        </div>


        <!-- –°–µ—Ç–∫–∞ —É—Å–ª—É–≥ -->
        <div class="services-grid">
            {{ range .services }}
            <div class="service-card">
                <img src="{{ .ImageURL }}" alt="{{ .Name }}" class="service-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='">
                <div class="service-content">
                    <h3 class="service-title">{{ .Name }}</h3>
                    <p class="service-description">{{ .Description }}</p>
                    <div class="service-actions">
                        <a href="/transport-services/{{ .ID }}" class="details-link">–ø–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                        <button class="consult-btn" data-service-id="{{.ID}}">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</button>
                    </div>
                </div>
            </div>
            {{ end }}
        </div>

        {{ if not .services }}
        <div class="no-results">
            <h2>–£—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
        </div>
        {{ end }}
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É
        async function addTransportServiceToDraftLogisticRequest(serviceId) {
            try {
                const response = await fetch(`/api/logistic-requests/draft/services/${serviceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º id –∫–æ—Ä–∑–∏–Ω—ã
                    updateCartCount(data.count);
                    loadCartCount();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification(data.message);
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É:', error);
                showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
        function updateCartCount(count, cartId) {
            const cartCountElement = document.getElementById('cartCount');
            toggleDeliveryQuoteBtn(count, cartId);
            if (cartCountElement) {
                if (count > 0) {
                    cartCountElement.textContent = count;
                    cartCountElement.style.display = 'flex';
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—É–ª—å—Å–∞—Ü–∏–∏
                    cartCountElement.style.animation = 'pulse 0.3s ease-in-out';
                } else {
                    cartCountElement.textContent = '';
                    cartCountElement.style.display = 'none';
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                ${type === 'success' ? 'background-color: #4CAF50;' : 'background-color: #f44336;'}
            `;
            
            document.body.appendChild(notification);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 100);
            
            // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function loadCartCount() {
            try {
                const response = await fetch('/api/logistic-requests/draft');
                const data = await response.json();
                const cartId = data?.cart?.id || data?.id || undefined;
                const count = data?.count ?? 0;
                updateCartCount(count, cartId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ:', error);
            }
        }


        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('consult-btn')) {
                const serviceId = e.target.getAttribute('data-service-id');
                if (serviceId) {
                    addTransportServiceToDraftLogisticRequest(parseInt(serviceId));
                }
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadCartCount);

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        function toggleDeliveryQuoteBtn(count, cartId) {
            const btn = document.getElementById('calculatorBtn');
            if (!btn) return;
            if (count > 0) {
                btn.classList.remove('is-disabled');
                btn.setAttribute('aria-disabled', 'false');
                const href = cartId ? `/logistic-request/quote?request_id=${cartId}` : '/logistic-request/quote';
                btn.setAttribute('href', href);
                btn.style.pointerEvents = 'auto';
                btn.style.backgroundColor = '';
            } else {
                btn.classList.add('is-disabled');
                btn.setAttribute('aria-disabled', 'true');
                // –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ—Ö–æ–¥–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤–∏–¥ —Å—Å—ã–ª–∫–∏
                btn.removeAttribute('href');
                btn.style.pointerEvents = 'none';
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–µ–º —Å–µ—Ä—ã–π —Ü–≤–µ—Ç, –µ—Å–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç—å CSS –º–µ—à–∞–µ—Ç
                btn.style.backgroundColor = '#adb5bd';
            }
        }
    </script>
</body>
</html>