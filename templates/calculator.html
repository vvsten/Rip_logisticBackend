<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - GruzDelivery</title>
    <link rel="stylesheet" href="/static/css/style.css?v=14">
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">üöö</div>
            GruzDelivery
        </a>
        <div class="header-actions">
            <a href="/" class="home-btn">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        </div>
    </header>

    <div class="container">
        <div class="calculator-page">
            <h1 class="calculator-title">–†–∞—Å—á—ë—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–ª—è –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏</h1>
            
            <div class="calculator-form">
                {{ if .CartServices }}
                    <!-- –û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                    <div class="common-params">
                        <h2 class="section-title">–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
                        <div class="direction-fields">
                            <div class="field-group">
                                <label class="field-label">–û—Ç–∫—É–¥–∞</label>
                                <input type="text" id="commonFromCity" class="form-input" placeholder="–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç" value="">
                            </div>
                            <div class="field-group">
                                <label class="field-label">–ö—É–¥–∞</label>
                                <input type="text" id="commonToCity" class="form-input" placeholder="–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç" value="">
                            </div>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ —É—Å–ª—É–≥ -->
                    <div class="services-table-container">
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø</th>
                                    <th>–î–ª–∏–Ω–∞ (–º)</th>
                                    <th>–®–∏—Ä–∏–Ω–∞ (–º)</th>
                                    <th>–í—ã—Å–æ—Ç–∞ (–º)</th>
                                    <th>–í–µ—Å (–∫–≥)</th>
                                    <th>–°—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range $index, $service := .CartServices }}
                                <tr class="service-row" data-service-id="{{ $service.ID }}">
                                    <td class="service-type">
                                        <div class="service-info">
                                            <img src="{{ $service.ImageURL }}" alt="{{ $service.Name }}" class="service-list-image" onerror="this.style.display='none'">
                                            <h3 class="service-name">{{ $service.Name }}</h3>
                                        </div>
                                    </td>
                                    <td class="cargo-param">
                                        <form class="service-calculator-form" data-service-id="{{ $service.ID }}">
                                            <input type="number" name="length" class="form-input" placeholder="0 –º" step="0.1" value="1">
                                        </form>
                                    </td>
                                    <td class="cargo-param">
                                        <input type="number" name="width" class="form-input" placeholder="0 –º" step="0.1" value="1">
                                    </td>
                                    <td class="cargo-param">
                                        <input type="number" name="height" class="form-input" placeholder="0 –º" step="0.1" value="1">
                                    </td>
                                    <td class="cargo-param">
                                        <input type="number" name="weight" class="form-input" placeholder="0 –∫–≥" step="0.1" value="1">
                                    </td>
                                    <td class="calculation-result">
                                        <div class="result-field" id="deliveryDays-{{ $service.ID }}">0 –¥–Ω–µ–π</div>
                                    </td>
                                    <td class="calculation-result">
                                        <div class="result-field" id="totalCost-{{ $service.ID }}">0 —Ä—É–±–ª–µ–π</div>
                                    </td>
                                    <td class="actions">
                                        <button type="button" class="remove-service-btn" data-service-id="{{ $service.ID }}" onclick="clearDraftLogisticRequest(this.dataset.serviceId)">√ó</button>
                                    </td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="total-summary">
                        <h2 class="section-title">–û–±—â–∏–π –∏—Ç–æ–≥</h2>
                        <div class="summary-fields">
                            <div class="field-group">
                                <label class="field-label">–û–±—â–∏–µ —Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                                <div class="result-field" id="totalDeliveryDays">0 –¥–Ω–µ–π</div>
                            </div>
                            <div class="field-group">
                                <label class="field-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                                <div class="result-field" id="totalCost">0 —Ä—É–±–ª–µ–π</div>
                            </div>
                        </div>
                        <button type="button" class="submit-btn" onclick="submitLogisticRequest()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                    </div>
                {{ else }}
                    <div class="no-services">
                        <h2>–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥</h2>
                        <p>–î–æ–±–∞–≤—å—Ç–µ —É—Å–ª—É–≥–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</p>
                        <a href="/" class="add-services-link">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏</a>
                    </div>
                {{ end }}
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∑–∞—è–≤–∫–∏
        async function clearDraftLogisticRequest(serviceId) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º ID –∑–∞—è–≤–∫–∏ –∏–∑ URL –∏–ª–∏ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('request_id') || getCurrentLogisticRequestId();
                
                console.log('–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ —Å ID:', orderId);
                
                if (!orderId) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞—è–≤–∫–∏');
                    return;
                }
                
                const response = await fetch(`/api/logistic-requests/draft`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                    updateCartCount(data.count);
                    
                    // –û—á–∏—â–∞–µ–º –≤—Å—é —Ç–∞–±–ª–∏—Ü—É —É—Å–ª—É–≥
                    const cartTable = document.querySelector('.services-table tbody');
                    if (cartTable) {
                        cartTable.innerHTML = '';
                    }
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–µ –∏—Ç–æ–≥–∏
                    calculateTotalSummary();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ —É—Å–ª—É–≥–∏
                    const serviceRows = document.querySelectorAll('.service-row');
                    
                    if (serviceRows.length === 0) {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç —É—Å–ª—É–≥"
                        window.location.reload();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification(data.message);
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã:', error);
                showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
        function updateCartCount(count) {
            const cartCountElement = document.getElementById('cartCount');
            if (cartCountElement) {
                if (count > 0) {
                    cartCountElement.textContent = count;
                    cartCountElement.style.display = 'flex';
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—É–ª—å—Å–∞—Ü–∏–∏
                    cartCountElement.style.animation = 'pulse 0.3s ease-in-out';
                } else {
                    cartCountElement.textContent = '';
                    cartCountElement.style.display = 'none';
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏
        function getCurrentLogisticRequestId() {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
            if (window.currentLogisticRequestId) {
                return window.currentLogisticRequestId;
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('request_id');
            if (orderId) {
                window.currentLogisticRequestId = orderId;
                return orderId;
            }
            
            return null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                ${type === 'success' ? 'background-color: #4CAF50;' : 'background-color: #f44336;'}
            `;
            
            document.body.appendChild(notification);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 100);
            
            // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function loadCartCount() {
            try {
                const response = await fetch('/api/logistic-requests/draft/count');
                const data = await response.json();
                updateCartCount(data.count);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —É—Å–ª—É–≥–∏
        async function calculateService(serviceId) {
            console.log('Calculating service:', serviceId);
            const row = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (!row) {
                console.log('Row not found for service:', serviceId);
                return;
            }

            const data = {
                service_id: parseInt(serviceId),
                from_city: document.getElementById('commonFromCity').value,
                to_city: document.getElementById('commonToCity').value,
                length: parseFloat(row.querySelector('input[name="length"]').value) || 0,
                width: parseFloat(row.querySelector('input[name="width"]').value) || 0,
                height: parseFloat(row.querySelector('input[name="height"]').value) || 0,
                weight: parseFloat(row.querySelector('input[name="weight"]').value) || 0
            };
            
            console.log('Sending data:', data);

            try {
                const response = await fetch('/api/logistic-requests/quote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Received result:', result);
                
                if (result.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —ç—Ç–æ–π —É—Å–ª—É–≥–∏
                    const daysElement = document.getElementById(`deliveryDays-${serviceId}`);
                    const costElement = document.getElementById(`totalCost-${serviceId}`);
                    
                    if (daysElement) {
                        daysElement.textContent = `${result.delivery_days} –¥–Ω–µ–π`;
                    } else {
                        console.log('Days element not found:', `deliveryDays-${serviceId}`);
                    }
                    
                    if (costElement) {
                        costElement.textContent = `${result.total_cost} —Ä—É–±–ª–µ–π`;
                    } else {
                        console.log('Cost element not found:', `totalCost-${serviceId}`);
                    }
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–µ –∏—Ç–æ–≥–∏
                    calculateTotalSummary();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–∏—Ö –∏—Ç–æ–≥–æ–≤
        function calculateTotalSummary() {
            let totalDeliveryDays = 0;
            let totalCost = 0;

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ –≤—Å–µ—Ö —É—Å–ª—É–≥
            const serviceForms = document.querySelectorAll('.service-calculator-form');
            serviceForms.forEach(serviceForm => {
                const serviceId = serviceForm.getAttribute('data-service-id');
                const deliveryDaysElement = document.getElementById(`deliveryDays-${serviceId}`);
                const totalCostElement = document.getElementById(`totalCost-${serviceId}`);

                if (deliveryDaysElement && totalCostElement) {
                    const deliveryDays = parseInt(deliveryDaysElement.textContent) || 0;
                    const cost = parseFloat(totalCostElement.textContent) || 0;

                    totalDeliveryDays = Math.max(totalDeliveryDays, deliveryDays); // –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
                    totalCost += cost;
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–µ –∏—Ç–æ–≥–∏
            document.getElementById('totalDeliveryDays').textContent = `${totalDeliveryDays} –¥–Ω–µ–π`;
            document.getElementById('totalCost').textContent = `${totalCost.toFixed(2)} —Ä—É–±–ª–µ–π`;
        }

        async function refreshAccessTokenIfPossible() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) return null;

            try {
                const res = await fetch('/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                const data = await res.json();
                if (!res.ok || !data.access_token) {
                    return null;
                }
                localStorage.setItem('access_token', data.access_token);
                if (data.refresh_token) localStorage.setItem('refresh_token', data.refresh_token);
                if (data.expires_at) localStorage.setItem('expires_at', data.expires_at);
                if (data.user) localStorage.setItem('user', JSON.stringify(data.user));
                return data.access_token;
            } catch (e) {
                console.error('refresh token failed:', e);
                return null;
            }
        }

        async function getValidAccessToken() {
            let token = localStorage.getItem('access_token');
            if (token) return token;
            token = await refreshAccessTokenIfPossible();
            return token;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏
        async function submitLogisticRequest() {
            const serviceRows = document.querySelectorAll('.service-row');
            if (serviceRows.length === 0) {
                showNotification('–ù–µ—Ç —É—Å–ª—É–≥ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏', 'error');
                return;
            }

            const fromCity = (document.getElementById('commonFromCity').value || '').trim();
            const toCity = (document.getElementById('commonToCity').value || '').trim();
            if (!fromCity || !toCity) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è "–û—Ç–∫—É–¥–∞" –∏ "–ö—É–¥–∞" –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º', 'error');
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ –≤—Å–µ—Ö —Ñ–æ—Ä–º
            const orderData = [];
            serviceRows.forEach(row => {
                const serviceId = row.getAttribute('data-service-id');
                const lengthEl = row.querySelector('input[name="length"]');
                const widthEl = row.querySelector('input[name="width"]');
                const heightEl = row.querySelector('input[name="height"]');
                const weightEl = row.querySelector('input[name="weight"]');

                const length = parseFloat(lengthEl?.value) || 0;
                const width = parseFloat(widthEl?.value) || 0;
                const height = parseFloat(heightEl?.value) || 0;
                const weight = parseFloat(weightEl?.value) || 0;

                orderData.push({
                    service_id: parseInt(serviceId),
                    from_city: fromCity,
                    to_city: toCity,
                    length,
                    width,
                    height,
                    weight
                });
            });

            // –ò—Ç–æ–≥–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ (FormLogisticRequest –æ–∂–∏–¥–∞–µ—Ç –æ–±—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è)
            const totals = orderData.reduce((acc, it) => {
                acc.weight += it.weight || 0;
                acc.length += it.length || 0;
                acc.width += it.width || 0;
                acc.height += it.height || 0;
                return acc;
            }, { weight: 0, length: 0, width: 0, height: 0 });

            if (totals.weight <= 0 || totals.length <= 0 || totals.width <= 0 || totals.height <= 0) {
                showNotification('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–∑–∞ (–≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å > 0)', 'error');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É (JWT-only auth)
            let token = await getValidAccessToken();
            if (!token) {
                showNotification('–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ (JWT —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω)', 'error');
                return;
            }

            const doRequest = async (accessToken) => {
                const response = await fetch('/api/logistic-requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: JSON.stringify({ services: orderData })
                });
                return response;
            };

            try {
                let response = await doRequest(token);
                if (response.status === 401) {
                    // access token –∏—Å—Ç—ë–∫/–Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Üí –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑
                    const newToken = await refreshAccessTokenIfPossible();
                    if (newToken) {
                        response = await doRequest(newToken);
                        token = newToken;
                    }
                }
                const data = await response.json();
                if (response.ok && (data.success || data.status === 'success')) {
                    const requestId = data.request_id;
                    // 1) –ü—ã—Ç–∞–µ–º—Å—è —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ —Å–ø–∏—Å–∫–µ (/orders)
                    // (–µ—Å–ª–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º –∏ –≤–µ–¥—ë–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞—è–≤–∫–∏)
                    let formed = false;
                    try {
                        let formResp = await fetch(`/api/logistic-requests/${requestId}/form`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`,
                            },
                            body: JSON.stringify({
                                from_city: fromCity,
                                to_city: toCity,
                                weight: totals.weight,
                                length: totals.length,
                                width: totals.width,
                                height: totals.height,
                            }),
                        });
                        if (formResp.status === 401) {
                            const newToken2 = await refreshAccessTokenIfPossible();
                            if (newToken2) {
                                token = newToken2;
                                formResp = await fetch(`/api/logistic-requests/${requestId}/form`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`,
                                    },
                                    body: JSON.stringify({
                                        from_city: fromCity,
                                        to_city: toCity,
                                        weight: totals.weight,
                                        length: totals.length,
                                        width: totals.width,
                                        height: totals.height,
                                    }),
                                });
                            }
                        }
                        formed = formResp.ok;
                    } catch (e) {
                        console.warn('FormLogisticRequest failed:', e);
                        formed = false;
                    }

                    // 2) –û—á–∏—â–∞–µ–º –≥–æ—Å—Ç–µ–≤—É—é –∫–æ—Ä–∑–∏–Ω—É/—á–µ—Ä–Ω–æ–≤–∏–∫
                    try {
                        await fetch('/api/logistic-requests/draft', { method: 'DELETE' });
                    } catch (e) {
                        console.warn('Failed to clear guest draft:', e);
                    }

                    showNotification('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!', 'success');
                    // 3) –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ React UI
                    setTimeout(() => {
                        if (formed) {
                            window.location.href = '/orders';
                        } else if (requestId) {
                            window.location.href = `/orders/${requestId}`;
                        } else {
                            window.location.href = '/';
                        }
                    }, 800);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' + (data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏:', error);
                showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏', 'error');
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
        function addCalculationListeners() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±—â–∏—Ö –ø–æ–ª–µ–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const commonFromCity = document.getElementById('commonFromCity');
            const commonToCity = document.getElementById('commonToCity');
            
            if (commonFromCity) {
                commonFromCity.addEventListener('input', () => {
                    calculateAllServices();
                });
            }
            
            if (commonToCity) {
                commonToCity.addEventListener('input', () => {
                    calculateAllServices();
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥—Ä—É–∑–∞ –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã
            const serviceRows = document.querySelectorAll('.service-row');
            serviceRows.forEach(row => {
                const inputs = row.querySelectorAll('input[name="length"], input[name="width"], input[name="height"], input[name="weight"]');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        const serviceId = row.getAttribute('data-service-id');
                        calculateService(serviceId);
                    });
                });
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥
        function calculateAllServices() {
            const serviceRows = document.querySelectorAll('.service-row');
            serviceRows.forEach(row => {
                const serviceId = row.getAttribute('data-service-id');
                calculateService(serviceId);
            });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ID –∑–∞—è–≤–∫–∏
            fetch('/api/logistic-requests/draft/icon')
                .then(response => response.json())
                .then(data => {
                    if (data.request_id) {
                        window.currentLogisticRequestId = data.request_id;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID –∑–∞—è–≤–∫–∏:', error);
                });
            
            loadCartCount();
            addCalculationListeners();
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => {
                calculateAllServices();
            }, 500);
        });
    </script>
</body>
</html>
